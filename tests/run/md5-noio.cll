// 2**16-1 = 65535
// 2**32-1 = 4294967295

int::2@(17, 29) leftrotate(int::2@(17,17) x, int@11 r) {
  int::2@(17, 29) out;
  int@17 swap;
  if(r >@11 16) {
    swap = x::0;
    x::0 = x::1;
    x::1 = swap;
  }
  out::0 = ((x::1 >>@17 (16 -@17 r)) |@17 (x::0 <<@17 r)) &@17 65535;
  out::1 = ((x::1 <<@17 r) |@17 (x::0 >>@17 (16 -@17 r))) &@29 65535;
  return out;
}

int::2@(28, 29) csum(int::2@(28, 29) x, int::2@(28, 29) y) {
  int::2@(28, 29) z;
  z::0 = x::0 +@28 y::0;
  z::1 = x::1 +@29 y::1 +@29 (z::0 >>@28 16);
  z::0 = z::0 &@28 65535;
  z::1 = z::1 &@29 65535;
  return z;
}

int::2@(10, 25) cadd(int::2@(24,25) x, int::2@(24,25) y) {
  int::2@(24,25) z;
  z::0 = x::0 +@24 y::0;
  z::1 = x::1 +@25 y::1 +@25 (z::0 >>@24 16);
  z::0 = z::0 &@24 65535;
  z::1 = z::1 &@25 65535;
  return z;
}

int::2@(0,1) sumrotate(int::2@(20,21) a, int::2@(21,20) b, int::2@(28,21) f, int::2@(2,3) k, int@4 m0, int@5 m1, int@6 r) {
  int::2@(4,5) m;
  m::0 = m0;
  m::1 = m1;
  return csum(b, leftrotate(csum(a +@(28,21) f +@(28,29) k, m), r));
}

void main() {
  int::2[]@({[0:16]=2,[16:32]=7,[32:64]=12},{[0:16]=3,[16:32]=8,[32:64]=13}) k[64]; // full = 64 entries
  int[]@{[0:16]=6,[16:32]=16,[32:48]=18,[48:64]=19} r[64];
  
  int::2@(20,21) a;
  int::2@(14,15) b;
  int::2@(26,27) c;
  int::2@(22,23) d;
  int::2@(30,31) f1;
  int::2@(32,33) f2;
  int::2@(0,1) temp;
  int::2[]@({[0:4]=10},{[0:4]=9}) hash[4];
  
  int::2[]@({[0:16]=4},{[0:16]=5}) message[16];
  int::2@(4,5) g;
  int::2@(4,5) inc;
  
  for(t from 0 to 16) {
    a = hash[0];
    b = hash[1];
    c = hash[2];
    d = hash[3];
    g::0 = 0;
    g::1 = 0;
    inc::0 = 1;
    inc::1 = 1;
    for(i from 0 to 16) { 
      f1 = (b &@(30,31) c) |@(30,31) ((b ^@(30,31) 4294967295) &@(30,31) d);
      temp = sumrotate(a,b,f1,k[i],message::0[i],message::1[i],r[i]);
	    a = d;
	    d = c;
	    c = b;
	    b = temp;
      g::0 = g::0 +@4 inc::0 &@4 15;
      g::1 = g::1 +@5 inc::1 &@5 15;
    }
    g::0 = 1;
    g::1 = 1;
    inc::0 = 5;
    inc::1 = 5;
    for(i from 16 to 32) { 
      f1 = (d &@(30,31) b) |@(30,31) ((d ^@(30,31) 4294967295) &@(30,31) c);
      temp = sumrotate(a,b,f1,k[i],message::0[g::0],message::1[g::1],r[i]);
	    a = d;
	    d = c;
	    c = b;
	    b = temp;
      g::0 = g::0 +@4 inc::0 &@4 15;
      g::1 = g::1 +@5 inc::1 &@5 15;
    }
    g::0 = 5;
    g::1 = 5;
    inc::0 = 3;
    inc::1 = 3;
    for(i from 32 to 48) { 
      f2 = b ^@(32,33) c ^@(32,33) d;
      temp = sumrotate(a,b,f2,k[i],message::0[g::0],message::1[g::1],r[i]);
	    a = d;
	    d = c;
	    c = b;
	    b = temp;
      g::0 = g::0 +@4 inc::0 &@4 15;
      g::1 = g::1 +@5 inc::1 &@5 15;
    }
    g = 0;
    inc::0 = 7;
    inc::1 = 7;
    for(i from 48 to 64) { 
      f2 = c ^@(32,33) (b |@(32,33) (d ^@(32,33) 4294967295));
      temp = sumrotate(a,b,f2,k[i],message::0[g::0],message::1[g::1],r[i]);
	    a = d;
	    d = c;
	    c = b;
	    b = temp;
      g::0 = g::0 +@4 inc::0 &@4 15;
      g::1 = g::1 +@5 inc::1 &@5 15;
    }
    hash[0] = cadd(hash[0],a);
    hash[1] = cadd(hash[1],b);
    hash[2] = cadd(hash[2],c);
    hash[3] = cadd(hash[3],d);
  } 

}

/*
core = 0, space = 272, ops = #<set:>
core = 1, space = 272, ops = #<set:>
core = 2, space = 417, ops = #<set:>
core = 3, space = 417, ops = #<set:>
core = 4, space = 471, ops = #<set:>
core = 5, space = 471, ops = #<set:>
core = 6, space = 385, ops = #<set:>
core = 7, space = 284, ops = #<set:>
core = 8, space = 284, ops = #<set:>
core = 9, space = 360, ops = #<set:>
core = 10, space = 400, ops = #<set:>
core = 11, space = 468, ops = #<set:>
core = 12, space = 348, ops = #<set:>
core = 13, space = 348, ops = #<set:>
core = 14, space = 408, ops = #<set:>
core = 15, space = 408, ops = #<set:>
core = 16, space = 284, ops = #<set:>
core = 17, space = 458, ops = #<set:>
core = 18, space = 284, ops = #<set:>
core = 19, space = 284, ops = #<set:>
core = 20, space = 450, ops = #<set:>
core = 21, space = 450, ops = #<set:>
core = 22, space = 344, ops = #<set:>
core = 23, space = 344, ops = #<set:>
core = 24, space = 339, ops = #<set:>
core = 25, space = 388, ops = #<set:>
core = 26, space = 328, ops = #<set:>
core = 27, space = 328, ops = #<set:>
core = 28, space = 439, ops = #<set:>
core = 29, space = 434, ops = #<set:>
core = 30, space = 421, ops = #<set:>
core = 31, space = 421, ops = #<set:>
core = 32, space = 0, ops = #<set:>
core = 33, space = 0, ops = #<set:>
core = 34, space = 0, ops = #<set:>
core = 35, space = 0, ops = #<set:>
core = 36, space = 0, ops = #<set:>
core = 37, space = 0, ops = #<set:>
core = 38, space = 0, ops = #<set:>
core = 39, space = 0, ops = #<set:>
core = 40, space = 0, ops = #<set:>
core = 41, space = 0, ops = #<set:>
*/

/* new
core = 0, space = 272, ops = #<set:>
core = 1, space = 272, ops = #<set:>
core = 2, space = 417, ops = #<set:>
core = 3, space = 417, ops = #<set:>
core = 4, space = 581, ops = #<set:>
core = 5, space = 581, ops = #<set:>
core = 6, space = 385, ops = #<set:>
core = 7, space = 284, ops = #<set:>
core = 8, space = 284, ops = #<set:>
core = 9, space = 360, ops = #<set:>
core = 10, space = 400, ops = #<set:>
core = 11, space = 274, ops = #<set:>
core = 12, space = 348, ops = #<set:>
core = 13, space = 348, ops = #<set:>
core = 14, space = 408, ops = #<set:>
core = 15, space = 408, ops = #<set:>
core = 16, space = 284, ops = #<set:>
core = 17, space = 402, ops = #<set:>
core = 18, space = 284, ops = #<set:>
core = 19, space = 284, ops = #<set:>
core = 20, space = 450, ops = #<set:>
core = 21, space = 561, ops = #<set:>
core = 22, space = 344, ops = #<set:>
core = 23, space = 344, ops = #<set:>
core = 24, space = 339, ops = #<set:>
core = 25, space = 388, ops = #<set:>
core = 26, space = 328, ops = #<set:>
core = 27, space = 328, ops = #<set:>
core = 28, space = 476, ops = #<set:>
core = 29, space = 396, ops = #<set:>
core = 30, space = 202, ops = #<set:>
core = 31, space = 202, ops = #<set:>
core = 32, space = 174, ops = #<set:>
core = 33, space = 174, ops = #<set:>
core = 34, space = 0, ops = #<set:>
core = 35, space = 0, ops = #<set:>
core = 36, space = 0, ops = #<set:>
core = 37, space = 0, ops = #<set:>
core = 38, space = 0, ops = #<set:>
core = 39, space = 0, ops = #<set:>
core = 40, space = 0, ops = #<set:>
core = 41, space = 0, ops = #<set:>
*/
